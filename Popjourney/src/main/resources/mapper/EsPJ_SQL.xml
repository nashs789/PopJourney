<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EsPJ">
	<select id="getPostCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM(SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                                 THEN 0
                                                                                 ELSE LIKE_CNT
                                                                            END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO AND B.CATEGORY_NO =1
		                                AND B.DEL = 1
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO)
		      WHERE RK BETWEEN 1 AND 5
		UNION
		SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                            THEN 0
                                                                            ELSE LIKE_CNT
                                                                       END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO)
		      WHERE DEL != 0
		      <choose>
				<when test="gradeNo == 0">
					AND (GRADE_NO = 1 OR GRADE_NO = 2) 
				</when>
				<when test="gradeNo == 2">
					AND GRADE_NO = 2
				</when>
				<when test="gradeNo == 1">
					AND GRADE_NO = 1
				</when>
				<when test="gradeNo == 3">
					AND MEM_NO = #{MEM_NO}
				</when>
			</choose>
			<choose>
				<when test="categoryNo == 0">
					AND CATEGORY_NO != 1)
				</when>
				<when test="categoryNo == 2">
					AND CATEGORY_NO = 2)
				</when>
				<when test="categoryNo == 3">
					AND CATEGORY_NO = 3)
				</when>
				<when test="categoryNo == 4">
					AND CATEGORY_NO = 4)
				</when>
			</choose>
			<if test="searchTxt != null and searchTxt !=''">
				<choose>
					<when test="selectFilter == 1">
							AND TITLE LIKE '%' || #{searchTxt} || '%'
					</when>
					<when test="selectFilter == 2">
							AND NIC LIKE '%' || #{searchTxt} || '%'
					</when>
				</choose>
			</if>
	</select>
	
	<select id="getPostList" parameterType="hashmap" resultType="hashmap">
		SELECT *
		FROM(SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                                 THEN 0
                                                                                 ELSE LIKE_CNT
                                                                            END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO AND B.CATEGORY_NO =1
		                                AND B.DEL = 1
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO)
		      WHERE RK BETWEEN 1 AND 5
		UNION
		SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                            THEN 0
                                                                            ELSE LIKE_CNT
                                                                       END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO)
		      WHERE DEL != 0
		      AND RK BETWEEN #{startCnt} AND #{endCnt}
		      <choose>
				<when test="gradeNo == 0">
					AND (GRADE_NO = 1 OR GRADE_NO = 2) 
				</when>
				<when test="gradeNo == 2">
					AND GRADE_NO = 2
				</when>
				<when test="gradeNo == 1">
					AND GRADE_NO = 1
				</when>
				<when test="gradeNo == 3">
					AND MEM_NO = #{MEM_NO}
				</when>
			</choose>
			<choose>
				<when test="categoryNo == 0">
					AND CATEGORY_NO != 1)
				</when>
				<when test="categoryNo == 2">
					AND CATEGORY_NO = 2)
				</when>
				<when test="categoryNo == 3">
					AND CATEGORY_NO = 3)
				</when>
				<when test="categoryNo == 4">
					AND CATEGORY_NO = 4)
				</when>
			</choose>
			<if test="searchTxt != null and searchTxt !=''">
				<choose>
					<when test="selectFilter == 1">
							AND TITLE LIKE '%' || #{searchTxt} || '%'
					</when>
					<when test="selectFilter == 2">
							AND NIC LIKE '%' || #{searchTxt} || '%'
					</when>
				</choose>
			</if>
		        ORDER BY DECODE(CATEGORY_NO, 1,1), RK
	</select>
	<select id="getPostNCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM(SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                                 THEN 0
                                                                                 ELSE LIKE_CNT
                                                                            END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO AND B.CATEGORY_NO =1
		                                AND B.DEL = 1
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO))
	</select>
	<select id="getPostNList" parameterType="hashmap" resultType="hashmap">
		SELECT *
		FROM(SELECT POST_NO, CATEGORY_NO, TITLE, HIT, BOARD_DATE, MEM_NO, GRADE_NO, CASE WHEN LIKE_CNT IS NULL
                                                                                 THEN 0
                                                                                 ELSE LIKE_CNT
                                                                            END AS LIKE_CNT, NIC, RK
		      FROM(SELECT B.POST_NO, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25) || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                                     THEN ' [0]'
		                                                                                     ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                                END
		                                                  ELSE B.TITLE || CASE WHEN BCMT.CMT_CNT IS NULL
		                                                                       THEN ' [0]'
		                                                                      ELSE ' [' || BCMT.CMT_CNT || ']'
		                                                                  END
		                                                  END AS TITLE, B.HIT, TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, M.NIC, RANK() OVER(ORDER BY B.BOARD_DATE DESC) AS RK, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		          			 	INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO AND B.CATEGORY_NO =1
		                                AND B.DEL = 1
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO)
		      WHERE RK BETWEEN #{startCnt} AND #{endCnt})
	</select>
	<!-- EsPJ.getPostCMTCnt -->
	<insert id="addPost" parameterType="hashmap">
		INSERT INTO BOARD(POST_NO,CATEGORY_NO, MEM_NO, TITLE ,CONTENTS )
		VALUES(POST_SEQ.NEXTVAL,#{categorySelect},#{MEM_NO},#{postTitle}, #{postCon})
	</insert>
	<select id="getPost" parameterType="hashmap" resultType="hashmap">
		SELECT POST_NO, TITLE, CONTENTS, BOARD_DATE, HIT,CATEGORY_NO, CASE WHEN LIKE_CNT IS NULL
                                                         THEN 0
                                                         ELSE LIKE_CNT
                                                         END AS LIKE_CNT, POST_CMT_CNT, MEM_NO, NIC, GRADE_NO, CASE WHEN MEM_POST_CNT IS NULL
                                                                                                                    THEN 0
                                                                                                                    ELSE MEM_POST_CNT
                                                                                                                    END AS MEM_POST_CNT, CASE WHEN MEM_CMT_CNT IS NULL
                                                                                                                                              THEN 0
                                                                                                                                              ELSE MEM_CMT_CNT
                                                                                                                                              END AS MEM_CMT_CNT,DEL
		      FROM(SELECT B.POST_NO, B.CONTENTS, BC.CATEGORY_NO, CASE WHEN LENGTH(B.TITLE) > 25
		                                                  THEN SUBSTR(B.TITLE,1 ,25)
		                                                  ELSE B.TITLE 
		                                                  END AS TITLE, B.HIT,CASE WHEN POST_CMT_CNT IS NULL
                                                                                   THEN 0
                                                                                   ELSE POST_CMT_CNT END AS POST_CMT_CNT 
                                                          , TO_CHAR(B.BOARD_DATE, 'YYYY-MM-DD') AS BOARD_DATE,
		                  M.MEM_NO, G.GRADE_NO, BLIKE.LIKE_CNT, PCNT.MEM_POST_CNT, MCCNT.MEM_CMT_CNT, M.NIC, B.DEL
		           FROM BOARD B INNER JOIN MEM M
		                                ON B.MEM_NO = M.MEM_NO AND LEAVE_DATE IS NULL
		           				INNER JOIN BOARD_CATEGORY BC
		                                ON B.CATEGORY_NO = BC.CATEGORY_NO
		                        INNER JOIN GRADE G
		                                ON B.MEM_NO = G.MEM_NO
		                        INNER JOIN GRADE_CATEGORY GC
		                                ON G.GRADE_NO = GC.GRADE_NO
		                        LEFT OUTER JOIN (SELECT B.POST_NO, COUNT(*) AS POST_CMT_CNT
		                                         FROM BOARD B INNER JOIN BOARD_CMT BC
		                                                              ON B.POST_NO = BC.POST_NO
		                                         GROUP BY B.POST_NO) BCMT
		                                     ON B.POST_NO = BCMT.POST_NO   
		                        LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) AS LIKE_CNT
		                                         FROM BOARD_LIKE
		                                         GROUP BY POST_NO)BLIKE 
		                                     ON B.POST_NO = BLIKE.POST_NO
                                LEFT OUTER JOIN (SELECT MEM_NO, COUNT(*) AS MEM_POST_CNT
		                                         FROM BOARD
		                                         GROUP BY MEM_NO)PCNT
		                                     ON B.MEM_NO = PCNT.MEM_NO
                                 LEFT OUTER JOIN (SELECT MEM_NO, COUNT(*) AS MEM_CMT_CNT
		                                         FROM BOARD_CMT
		                                         GROUP BY MEM_NO)MCCNT
		                                     ON B.MEM_NO = MCCNT.MEM_NO)
                                           
		      WHERE DEL != 0
              AND POST_NO= 49
	</select>
	<update id="postUpdate" parameterType="hashmap">
		UPDATE BOARD SET POST_NO = #{postNo}, TITLE = #{postTitle}, CONTENTS = #{postCon}, CATEGORY_NO = #{categoryNo} 
		WHERE POST_NO = #{postNo}
	</update>
	<delete id="postDelete" parameterType="hashmap">
		UPDATE  BOARD SET DEL = 0
		WHERE POST_NO = #{postNo}
	</delete>
	
</mapper>